<!DOCTYPE html>
<html>
<head>
  <title>TTRPG Cards Creator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="common.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="common.js"></script>
  <script type="text/javascript" src="equipment.json"></script>
  <style>
    @media print {
      body { visibility: hidden; }
      #grid-container {
        visibility: visible;
        position: absolute;
        left: 0; top: 0;
      }
    }
  </style>
</head>

<body>

<div id="controls" style="position:absolute; left: 0px; top: 0px;">
    <label for="controls-groups">Groups (Categories):</label><br/ >
    <select id="controls-groups" onchange="selectGroup(this);" style="width:200px;">
      <option value=""></option>
    </select><br /><br />
    <select id="controls-custom-select" size="30" style="width:200px;"></select><br />
</div>

<div class="grid-container-card" id="grid-container">
</div>

<script type="text/javascript">
  var i = 0;
  var groups = {};
  var items = getAPI()['results'];

  function getAPI(r_url, r_async) {
    var r_text;
    if ( r_url == undefined) { var r_url = "/api/magic-items/"; }
    $.get({
      url: "https://www.dnd5eapi.co" + r_url,
      success: function(result) { r_text = result },
      error: function(xhr, error) { console.log(xhr) },
      async: r_async || false
    });
    return r_text;
  }

  function createCard(id) {
    var item;
    $.each( equipment, function( key, value ) {
      if ( value.index == id ) {
	item = value;
      }
    });
    $.each( items, function( key, value ) {
      if ( value.index == id ) {
	item = getAPI(value.url);
      }
    });
    if ( item ) {
	$('<div>', { id: 'card-' + id + '-' + i, class: 'card' }).appendTo('#grid-container');
	$('<img>', { src: item.image }).appendTo('#card-' + id + '-' + i);
	$('<h4>', { html: item.name }).appendTo('#card-' + id + '-' + i);
	$('<p>', { class: 'info', html: '<p>' + item.desc[0] + '</p>' }).appendTo('#card-' + id + '-' + i);
	var desc = "";
	$.each( item.desc, function( k, v ) {
	  if ( k > 0 ) { desc = desc + '<p>' + markdownParser(v) + '</p>'; }
	});
	$('<p>', { class: 'content', html: desc }).appendTo('#card-' + id + '-' + i);
	var notes = "";
	$.each( item.properties, function( k, v ) {
	  if ( k > 0 ) { notes = notes + ', ' + v; } else { notes = notes + "<br /><b>Notes</b>: " + v; }
	});
	$('<p>', { class: 'notes', html: notes }).appendTo('#card-' + id + '-' + i);
        i += 1;
    }
  }

  function selectGroup(el) {
    $('#grid-container').empty();
    var sel = el.options[el.selectedIndex].value;
    $.each( groups[sel], function( key, value ) {
      createCard(value);
    });
  }

  // populate select lists and register callback
  var categories = getAPI("/api/equipment-categories")['results'];
  $.each( categories, function ( key, value ) {
    $('#controls-groups').append('<option id="' + value.index + '" value="' + value.index +'">' + value.name +'</option>');
    groups[value.index] = [];
    var equip = getAPI(value.url)['equipment'];
    $.each( equip, function( k, v ) {
      groups[value.index].push(v.index);
    });
  });
  $.each( equipment, function( key, value ) {
    $('#controls-custom-select').append($("<option />").val(value.index).text(value.name));
    $.each( groups, function( k, v ) {
      if ( k == value.equipment_category.index ) { groups[k].push(value.index); }
    });
  });
  $.each( items, function( key, value ) {
    $('#controls-custom-select').append($("<option />").val(value.index).text(value.name));
  });
  document.getElementById('controls-custom-select').ondblclick = function() {
    createCard(this.options[this.selectedIndex].value);
  };
</script>

</body>
</html>